import os
import ctypes
import numpy as np

WD_N_CHANNELS = 18
WD_N_CELLS = 1024


class VoltageCalibration(object):
    """
    Voltage Calibration Class
    """

    class VoltageCalibrationBinaryData(ctypes.Structure):
        _fields_ = [
            ('version_id', ctypes.c_char * 4),
            ('crc', ctypes.c_int),
            ('sampling_frequency', ctypes.c_short),
            ('padding', ctypes.c_short),
            ('temperature', ctypes.c_float),
            ('wf_offset1', ctypes.c_float * 1024 * 18),
            ('wf_offset2', ctypes.c_float * 1024 * 18),
            ('wf_gain1', ctypes.c_float * 1024 * 18),
            ('wf_gain2', ctypes.c_float * 1024 * 18),
            ('drs_offset_range0', ctypes.c_float * 16),
            ('drs_offset_range1', ctypes.c_float * 16),
            ('drs_offset_range2', ctypes.c_float * 16),
            ('adc_offset_range0', ctypes.c_float * 16),
            ('adc_offset_range1', ctypes.c_float * 16),
            ('adc_offset_range2', ctypes.c_float * 16)
        ]

    def __init__(self, filename=None):
        if filename is None:
            self.valid = False
        else:
            self.valid = self.load(filename)

    def load(self, filename):
        # check file size
        if os.path.getsize(filename) != ctypes.sizeof(self.VoltageCalibrationBinaryData):
            print("Voltage Cal: %s has wrong file size!" % filename)
            return False

        cbd = self.VoltageCalibrationBinaryData()

        with open(filename, 'rb') as file:
            file.readinto(cbd)

        if cbd.version_id != b"CAL2":
            print("Voltage Cal: %s has wrong version!" % filename)
            return False

        self.version_id = str(cbd.version_id)
        self.crc = int(cbd.crc)
        self.sampling_frequency = float(cbd.sampling_frequency)
        self.temperature = float(cbd.temperature)
        self.wf_offset1 = np.ctypeslib.as_array(cbd.wf_offset1)
        self.wf_offset2 = np.ctypeslib.as_array(cbd.wf_offset2)
        self.wf_gain1 = np.ctypeslib.as_array(cbd.wf_gain1)
        self.wf_gain2 = np.ctypeslib.as_array(cbd.wf_gain2)
        self.drs_offset_range0 = np.ctypeslib.as_array(cbd.drs_offset_range0)
        self.drs_offset_range1 = np.ctypeslib.as_array(cbd.drs_offset_range1)
        self.drs_offset_range2 = np.ctypeslib.as_array(cbd.drs_offset_range2)
        self.adc_offset_range0 = np.ctypeslib.as_array(cbd.adc_offset_range0)
        self.adc_offset_range1 = np.ctypeslib.as_array(cbd.adc_offset_range1)
        self.adc_offset_range2 = np.ctypeslib.as_array(cbd.adc_offset_range2)

        return True

    def dump(self):
        print("Voltage Cal Version %-4s  CRC=0x%08x  Freq: %4d  Temperature %.2f deg. C" % (
            self.version_id, self.crc, self.sampling_frequency, self.temperature))

        for ch in range(WD_N_CHANNELS):
            for cell in range(1024):
                print("ch %2d - cell %4d :  offset1: %10.6f   offset2: %10.6f   gain1: %10.6f   gain2: %10.6f" % (
                    ch, cell, self.wf_offset1[ch][cell], self.wf_offset2[ch][cell], self.wf_gain1[ch][cell],
                    self.wf_gain2[ch][cell]))

        for ch in range(WD_N_CHANNELS - 2):
            print("ch %2d :  %.6f  %.6f  %.6f  %.6f  %.6f  %.6f" % (
                ch, self.drs_offset_range0[ch], self.drs_offset_range1[ch], self.drs_offset_range2[ch],
                self.adc_offset_range0[ch], self.adc_offset_range1[ch], self.adc_offset_range2[ch]));

    def calibrate(self, data, trigger_cell, channel):
        # cell-by-cell offset calibration
        data -= np.roll(self.wf_offset1[channel], -trigger_cell)

        # start-to-end offset calibration
        data -= self.wf_offset2[channel]

        # gain calibration
        msk_gtz = data > 0  # create boolean mask vector for selection
        data[msk_gtz] /= np.roll(self.wf_gain1[channel], -trigger_cell)[msk_gtz]
        data[~msk_gtz] /= np.roll(self.wf_gain2[channel], -trigger_cell)[~msk_gtz]

        return data


raw_value_from_stream = [1928, 1901, 1947, 1873, 1947, 1876, 1895, 1890, 1919, 1853, 1901, 1846, 1912, 1860, 1880, 1827, 1889, 1845, 1923, 1839, 1882, 1839, 1884, 1835, 1912, 1865, 1925, 1870, 1935, 1878, 1934, 1859, 1888, 1838, 1879, 1798, 1870, 1846, 1897, 1860, 1913, 1885, 1892, 1848, 1867, 1815, 1914, 1849, 1895, 1856, 1925, 1833, 1900, 1828, 1907, 1854, 1899, 1839, 1936, 1839, 1933, 1835, 1898, 1851, 1894, 1841, 1905, 1847, 1909, 1864, 1874, 1866, 1889, 1845, 1896, 1924, 1929, 1848, 1904, 1848, 1940, 1824, 1925, 1843, 1912, 1784, 1916, 1873, 1904, 1839, 1905, 1815, 1859, 1826, 1872, 1836, 1866, 1845, 1893, 1825, 1913, 1839, 1901, 1832, 1955, 1850, 1922, 1885, 1935, 1889, 1956, 1869, 1933, 1852, 1927, 1874, 1938, 1897, 1915, 1878, 1921, 1882, 1904, 1823, 1892, 1829, 1856, 1837, 1857, 1836, 1845, 1855, 1909, 1836, 1918, 1841, 1899, 1858, 1927, 1850, 1870, 1824, 1899, 1856, 1933, 1867, 1901, 1865, 1945, 1835, 1916, 1835, 1912, 1851, 1912, 1880, 1947, 1900, 1930, 1844, 1957, 1878, 1937, 1852, 1900, 1844, 1916, 1839, 1899, 1887, 1903, 1833, 1894, 1845, 1881, 1810, 1879, 1833, 1871, 1841, 1900, 1862, 1872, 1955, 2006, 1929, 1966, 1929, 1952, 1803, 1898, 1849, 1936, 1840, 1919, 1830, 1908, 1903, 1932, 1905, 1900, 1923, 1956, 1929, 1924, 1921, 1883, 1947, 1930, 1956, 1957, 1956, 1952, 1916, 1935, 1917, 1963, 1919, 1898, 1940, 1902, 1906, 1914, 1884, 1891, 1938, 1905, 1910, 1923, 1872, 1919, 1913, 1903, 1896, 1880, 1919, 1913, 1925, 1928, 1924, 1909, 1951, 1918, 1896, 1902, 1886, 1908, 1899, 1924, 1899, 1868, 1924, 1910, 1928, 1903, 1894, 1907, 1903, 1904, 1933, 1906, 1931, 1910, 1930, 1927, 1894, 1898, 1936, 1917, 1915, 1924, 1897, 1936, 1893, 1932, 1908, 1854, 1911, 1878, 1926, 1863, 1900, 1922, 1888, 1886, 1917, 1913, 1866, 1894, 1887, 1896, 1886, 1879, 1880, 1884, 1917, 1909, 1897, 1948, 1942, 1912, 1897, 1906, 1935, 1904, 1906, 1945, 1941, 1923, 1929, 1916, 1934, 1942, 1910, 1862, 1884, 1940, 1915, 1928, 1929, 1914, 1891, 1892, 1862, 1881, 1896, 1900, 1905, 1932, 1912, 1865, 1932, 1875, 1922, 1914, 1887, 1906, 1867, 1872, 1890, 1907, 1899, 1901, 1933, 1914, 1943, 1862, 1849, 1886, 1853, 1865, 1827, 1848, 1835, 1862, 1834, 1860, 1843, 1915, 1894, 1865, 1845, 1834, 1842, 1834, 1845, 1870, 1851, 1816, 1819, 1822, 1821, 1854, 1811, 1828, 1806, 1805, 1843, 1807, 1844, 1809, 1853, 1837, 1842, 1862, 1819, 1876, 1838, 1833, 1862, 1820, 1806, 1825, 1805, 1824, 1848, 1793, 1816, 1846, 1852, 1815, 1830, 1857, 1870, 1885, 1848, 1851, 1847, 1821, 1817, 1801, 1840, 1837, 1820, 1846, 1883, 1905, 1874, 1874, 1856, 1861, 1886, 1848, 1829, 1833, 1844, 1863, 1853, 1827, 1827, 1818, 1825, 1836, 1850, 1804, 1851, 1825, 1853, 1835, 1866, 1853, 1825, 1857, 1839, 1840, 1866, 1836, 1833, 1833, 1793, 1844, 1835, 1839, 1842, 1883, 1866, 1815, 1831, 1860, 1841, 1898, 1805, 1878, 1856, 1860, 1863, 1889, 1873, 1900, 1862, 1869, 1889, 1840, 1860, 1859, 1826, 1813, 1827, 1835, 1817, 1798, 1840, 1817, 1847, 1818, 1850, 1891, 1855, 1823, 1865, 1880, 1818, 1847, 1826, 1850, 1846, 1833, 1779, 1848, 1859, 1862, 1832, 1838, 1897, 1850, 1903, 1859, 1877, 1883, 1821, 1803, 1840, 1890, 1872, 1884, 1887, 1862, 1887, 1898, 1928, 1876, 1839, 1848, 1866, 1836, 1816, 1849, 1869, 1848, 1886, 1867, 1865, 1803, 1828, 1826, 1844, 1818, 1811, 1883, 1832, 1829, 1840, 1875, 1869, 1841, 1855, 1864, 1841, 1796, 1831, 1844, 1872, 1876, 1917, 1895, 1887, 1871, 1879, 1881, 1864, 1837, 1869, 1851, 1862, 1862, 1872, 1880, 1853, 1871, 1829, 1892, 1905, 1851, 1864, 1849, 1883, 1834, 1851, 1841, 1863, 1837, 1856, 1878, 1837, 1851, 1848, 1893, 1861, 1860, 1878, 1872, 1865, 1887, 1890, 1865, 1880, 1867, 1848, 1911, 1824, 1872, 1855, 1906, 1873, 1873, 1838, 1883, 1837, 1855, 1896, 1840, 1887, 1880, 1931, 1879, 1910, 1926, 1869, 1906, 1910, 1861, 1840, 1879, 1867, 1828, 1828, 1853, 1851, 1884, 1844, 1875, 1858, 1840, 1884, 1879, 1908, 1932, 1863, 1864, 1887, 1882, 1888, 1813, 1851, 1885, 1851, 1886, 1888, 1867, 1874, 1829, 1871, 1909, 1902, 1875, 1834, 1837, 1826, 1851, 1853, 1857, 1838, 1893, 1893, 1886, 1857, 1891, 1889, 1901, 1857, 1829, 1877, 1869, 1878, 1907, 1874, 1899, 1902, 1935, 1911, 1891, 1920, 1901, 1894, 1897, 1875, 1882, 1887, 1901, 1875, 1910, 1913, 1866, 1895, 1910, 1915, 1911, 1903, 1914, 1899, 1916, 1862, 1878, 1859, 1883, 1921, 1917, 1958, 1918, 1838, 1905, 1841, 1899, 1833, 1880, 1804, 1886, 1852, 1881, 1810, 1923, 1818, 1838, 1827, 1911, 1815, 1839, 1818, 1869, 1817, 1860, 1831, 1881, 1792, 1859, 1825, 1844, 1796, 1844, 1789, 1866, 1831, 1881, 1831, 1902, 1877, 1884, 1840, 1907, 1862, 1886, 1866, 1902, 1871, 1932, 1826, 1888, 1808, 1868, 1779, 1859, 1828, 1866, 1805, 1875, 1793, 1857, 1813, 1914, 1819, 1917, 1857, 1908, 1840, 1873, 1827, 1897, 1861, 1897, 1801, 1892, 1816, 1876, 1831, 1906, 1853, 1879, 1861, 1871, 1808, 1860, 1851, 1880, 1801, 1884, 1829, 1898, 1830, 1886, 1846, 1904, 1869, 1894, 1830, 1914, 1855, 1881, 1845, 1909, 1856, 1873, 1817, 1848, 1820, 1851, 1785, 1848, 1820, 1883, 1834, 1905, 1857, 1900, 1809, 1895, 1845, 1898, 1835, 1906, 1866, 1916, 1834, 1936, 1878, 1922, 1874, 1877, 1837, 1901, 1861, 1880, 1846, 1900, 1834, 1903, 1821, 1901, 1834, 1898, 1811, 1896, 1809, 1897, 1813, 1896, 1809, 1910, 1810, 1851, 1832, 1886, 1838, 1927, 1804, 1914, 1832, 1844, 1844, 1896, 1842, 1867, 1831, 1878, 1847, 1910, 1852, 1911, 1801, 1869, 1797, 1847, 1834, 1897, 1808, 1907, 1882, 1923, 1885, 1875, 1840, 1861, 1820, 1865, 1834, 1867, 1810, 1904, 1820, 1933, 1870, 1919, 1877, 1916, 1867, 1901, 1856, 1903, 1829, 1890, 1822, 1895, 1861, 1885, 1862, 1909, 1859, 1891, 1845, 1918, 1879, 1914, 1852, 1907, 1858, 1910, 1870, 1944, 1854, 1918, 1865, 1902, 1876, 1945, 1854, 1906, 1885, 1918, 1866, 1914, 1856, 1853, 1848, 1889, 1788, 1889, 1814, 1886, 1801, 1862, 1816, 1849, 1827, 1888, 1855, 1913, 1841, 1913, 1862, 1876, 1854, 1915, 1846, 1882, 1852, 1899, 1853, 1888, 1800, 1890, 1833, 1851, 1828, 1895, 1844, 1911, 1863, 1942, 1904, 1930, 1833, 1914, 1885, 1910, 1840, 1889, 1811, 1860, 1795, 1848, 1783, 1881, 1822, 1814, 1797, 1907, 1852, 1948, 1848, 1921, 1840, 1911, 1842, 1870, 1841, 1902, 1794, 1888, 1791, 1899, 1803, 1893, 1807, 1917, 1845, 1913, 1846, 1911, 1859, 1936, 1869, 1931, 1873, 1920, 1919]
calibrated_value_from_stream = [-0.0098376013, -0.0075793541, -0.0078630634, -0.0064564613, -0.0064687496, -0.0075925188, -0.0076016635, -0.0087133041, -0.0098455064, -0.0098360199, -0.009836548, -0.011241223, -0.010674698, -0.012635235, -0.012917347, -0.013468147, -0.011786772, -0.011228971, -0.01067525, -0.012644691, -0.012080274, -0.010675942, -0.0075764135, -0.0036525745, 0.00084269664, 0.0022454462, 0.0042099892, 0.0030886692, 0.0025280898, 0.0014069523, -0.0016853933, -0.0025259831, -0.0019657658, -0.0061759418, -0.0047651376, -0.0047600744, -0.0053128148, -0.0058805225, -0.0072822375, -0.0067303791, -0.0058897813, -0.0050474401, -0.0067388061, -0.007575715, -0.01179411, -0.012632054, -0.014032366, -0.01348176, -0.0095488215, -0.0056197429, -0.0011232477, -0.00084042316, 0.00028473604, 0.0011200996, 0.0014001244, 0.0028061955, 0.0033718399, 0.0047784448, 0.003653615, 0.0025319527, -0.00056408113, -0.0042117275, -0.0070214239, -0.0092652924, -0.0087010683, -0.0095365774, -0.0081315469, -0.0070069111, -0.0075741303, -0.0053316616, -0.007308119, -0.0084311794, -0.0120913, -0.013495797, -0.012372898, -0.010961024, -0.0092812497, -0.0067450809, -0.0061913701, -0.0073119719, -0.0073124995, -0.0075842696, -0.0070275748, -0.008983884, -0.009541844, -0.0092628729, -0.0078540109, -0.0067276121, -0.0036375376, -0.0019580845, -0.002797463, -0.0044803983, -0.007001163, -0.0064458195, -0.0070072813, -0.0058891014, -0.0072971079, -0.0084175374, -0.011781873, -0.0137445, -0.012894852, -0.011492413, -0.0072957091, -0.0039329417, 0.00028089888, 0.0061875, 0.0075891819, 0.0098488545, 0.0073067034, 0.0033771079, 0.00084322272, -0.0011197331, -0.0044931537, -0.0073075807, -0.0098419972, -0.013208955, -0.012365205, -0.011230712, -0.010116051, -0.0092744026, -0.010397651, -0.010388888, -0.010678924, -0.011503744, -0.0103718, -0.0092509808, -0.011212243, -0.010929421, -0.011203692, -0.010374564, -0.010100498, -0.0098227244, -0.011237733, -0.012366584, -0.014055884, -0.014884346, -0.014607458, -0.014325346, -0.014051992, -0.012368867, -0.0103945, -0.0078665782, -0.005625362, -0.0045028143, -0.0033737749, -0.0044999998, -0.0053497269, -0.0078700809, -0.010680825, -0.014051269, -0.016302705, -0.017135039, -0.012637332, -0.0081458921, -0.0014053718, 0.0047782632, 0.0067457836, 0.0095568774, 0.01095875, 0.0084360996, 0.0056172749, 0.0011242973, -0.0047770524, -0.0064549269, -0.0081413668, -0.0089809187, -0.0084276991, -0.0070207398, -0.0075827101, -0.0081406543, -0.0092570987, -0.0098218508, -0.010943009, -0.010375278, -0.0092485342, -0.007851176, -0.0050432375, -0.0028037382, -0.0011197495, 0.0019626168, 0.0028054905, 0.0028107432, 0.00055705453, -0.0019662904, -0.0050642551, -0.0087112049, -0.0087155979, -0.0081438087, -0.0058964491, -0.0050434312, -0.0019573881, -0.00056179124, -0.0013952511, -0.0022426397, -0.0064561409, -0.008700869, -0.011798121, -0.011241593, -0.011538638, -0.0101185, -0.010118675, -0.010961899, -0.01039975, -0.0098367231, -0.0090005267, -0.0075937496, -0.0067499997, -0.0061913701, -0.0050679524, -0.0014030836, 0.00026983116, 0.0022459598, 0.0036501063, 0.0033737691, 0.0025282626, 0.00056144595, 0.00028019713, 0.00028160063, 0.0011242973, 0.0014004774, 0.0036424224, 0.0013968144, 0.00056161708, -0.00083955226, -0.0039312071, -0.0056183385, -0.0089985998, -0.0089943781, -0.0095624998, -0.0089933285, -0.0087159509, -0.0092726741, -0.0087061636, -0.0098178349, -0.010110298, -0.012072554, -0.012650155, -0.010394856, -0.0070316009, -0.003089885, 0.00084023643, 0.0019719121, 0.00083583966, -0.0030944492, -0.007316011, -0.0109598, -0.011807599, -0.011793382, -0.0089916047, -0.0089870319, -0.0070207324, -0.0064531658, -0.0041998718, -0.0044788355, -0.005038375, -0.0058868192, -0.0067234235, -0.007011978, -0.004202472, -0.002800249, -0.00028019922, -0.00055987475, -0.0013996006, -0.0033634417, -0.0016789304, 2.6153866e-06, 0.0019603483, 0.0036467933, 0.0042108642, 0.0025230199, 0.00084181933, 0.00028142059, 0.0022422913, 0.0022395016, 1.0448275e-06, -0.0025197009, -0.003358209, -0.0033606561, -0.0030764448, -0.0019589553, -0.0016780609, -0.0030862275, -0.0050544436, -0.0053306236, -0.0047709174, -0.0058878688, -0.0081328023, -0.0103718, -0.011216963, -0.010934094, -0.010092122, -0.0084060077, -0.0067290133, -0.0056141447, -0.0056208023, -0.0022485948, -0.0011211392, 0.00084567955, 0.004216115, 0.0039291047, 0.0047654859, 0.0022415922, 1.0436634e-06, -0.001683994, -0.0030925195, -0.0025317743, -0.0050624991, -0.0070247506, -0.0089943791, -0.010954881, -0.011524048, -0.013754612, -0.014045194, -0.016556429, -0.014316414, -0.012911918, -0.010096315, -0.0081350692, -0.0070216106, -0.0058985255, -0.0061841616, -0.0078567704, -0.0070198704, -0.0092607606, -0.0084196366, -0.0078543294, -0.007571362, -0.0078553986, -0.0098227616, -0.01009911, -0.011227067, -0.012632594, -0.011511648, -0.010385749, -0.0092591979, -0.0092532653, -0.0092534302, -0.0089705978, -0.0084081236, -0.007285553, -0.0086986218, -0.0078590577, -0.0081487084, -0.0087091113, -0.0081427703, -0.0098136421, -0.0095257815, -0.012610565, -0.014854962, -0.01792587, -0.02158032, -0.024624946, -0.02745101, -0.028282851, -0.029432047, -0.028286092, -0.027738314, -0.025792766, -0.026921339, -0.025498988, -0.026929297, -0.02943988, -0.028031968, -0.03140299, -0.031671125, -0.032796998, -0.031403214, -0.031422883, -0.031958364, -0.031111097, -0.032802116, -0.034183394, -0.036411755, -0.038685389, -0.039812967, -0.041189354, -0.03923906, -0.037842691, -0.033067167, -0.029429898, -0.025484608, -0.023799891, -0.023512417, -0.022956718, -0.026352772, -0.026892731, -0.029133905, -0.03027153, -0.0294278, -0.031401567, -0.031683519, -0.034189273, -0.034189988, -0.034462288, -0.033898752, -0.031689249, -0.03028826, -0.029432479, -0.029145004, -0.028043043, -0.028863806, -0.025506996, -0.023541827, -0.02045426, -0.019610414, -0.02016516, -0.020722415, -0.024654783, -0.026881577, -0.028572153, -0.029104555, -0.028277161, -0.024068739, -0.021536512, -0.016497103, -0.012583891, -0.012865134, -0.009795472, -0.010068191, -0.010354651, -0.012323897, -0.016227547, -0.018451117, -0.020725746, -0.023535606, -0.024953699, -0.027190797, -0.029153422, -0.031671125, -0.032521345, -0.03308139, -0.031971399, -0.032819189, -0.033345215, -0.034469858, -0.034499414, -0.031973068, -0.031683739, -0.028300408, -0.026340231, -0.025505599, -0.023825714, -0.022990219, -0.024393085, -0.023521639, -0.023247313, -0.021816188, -0.019576682, -0.019593224, -0.020447936, -0.025212262, -0.026070651, -0.028900452, -0.028621301, -0.028342154, -0.029163517, -0.029688608, -0.030286767, -0.029732868, -0.027488211, -0.024974052, -0.022157183, -0.020743309, -0.021599744, -0.021048063, -0.020482823, -0.019915082, -0.021884419, -0.021040786, -0.022715487, -0.022989362, -0.025777927, -0.02690208, -0.028313104, -0.027443767, -0.028581768, -0.026895866, -0.028559461, -0.029947443, -0.030777011, -0.031331059, -0.032505974, -0.033072323, -0.031128369, -0.031113807, -0.029710241, -0.031101605, -0.029175062, -0.028311644, -0.027760286, -0.025224019, -0.025485029, -0.024363907, -0.02548603, -0.026059156, -0.027186885, -0.026924346, -0.027168583, -0.024640325, -0.024636654, -0.018190298, -0.014287882, -0.010629801, -0.0069962684, -0.0058817361, -0.0053255232, -0.0078323381, -0.011764006, -0.018474875, -0.021563899, -0.023237189, -0.02158032, -0.02073242, -0.01738514, -0.017666081, -0.016261738, -0.015436897, -0.015723731, -0.017131954, -0.020483796, -0.023273267, -0.028601062, -0.03029782, -0.034206063, -0.03391511, -0.033347514, -0.03137999, -0.026642555, -0.02465765, -0.024939796, -0.025770497, -0.028871965, -0.03025407, -0.031962041, -0.031923484, -0.028851431, -0.028861314, -0.027742956, -0.025784198, -0.025232673, -0.023828268, -0.021869313, -0.02212273, -0.021014892, -0.022408955, -0.025770593, -0.025504988, -0.0260696, -0.023255965, -0.019879792, -0.016778642, -0.013435666, -0.012037283, -0.010077465, -0.0095224548, -0.0095236674, -0.010085527, -0.013446847, -0.01372737, -0.016251057, -0.015411176, -0.01820709, -0.01820709, -0.017361227, -0.014544591, -0.01258476, -0.011193682, -0.01090984, -0.014573039, -0.017375901, -0.021871425, -0.025811294, -0.026064446, -0.026637593, -0.023520684, -0.022121355, -0.018750567, -0.017344149, -0.016792269, -0.019328015, -0.022985857, -0.02354203, -0.026919143, -0.026925268, -0.027491443, -0.026916476, -0.026368894, -0.023569252, -0.024680037, -0.024407495, -0.025810068, -0.023579668, -0.021330988, -0.019333884, -0.014840486, -0.013731513, -0.013982273, -0.016518535, -0.017083131, -0.01735813, -0.016797379, -0.01876713, -0.021295575, -0.023259426, -0.027191579, -0.029156771, -0.030849401, -0.031662013, -0.029140903, -0.026908856, -0.024963003, -0.022443943, -0.019367071, -0.017968535, -0.015164311, -0.015144473, -0.014587244, -0.014011445, -0.015408961, -0.015967967, -0.019050244, -0.020187184, -0.021602344, -0.022161119, -0.021324582, -0.02103911, -0.020175839, -0.020441562, -0.018194724, -0.016522206, -0.015676536, -0.013165539, -0.011192663, -0.0089594163, -0.0067164181, -0.0072809951, -0.0064294338, -0.0075493604, -0.0086607719, -0.0097904252, -0.010059678, -0.011179256, -0.015666315, -0.016807815, -0.020474784, -0.02328372, -0.023281269, -0.021882571, -0.019344995, -0.017103571, -0.014015947, -0.013731714, -0.013718322, -0.016259432, -0.019049441, -0.021292444, -0.022417832, -0.023513842, -0.021271456, -0.020735268, -0.019309178, -0.016802538, -0.017916046, -0.017074261, -0.018209875, -0.017381482, -0.019630078, -0.020754375, -0.022994854, -0.023269076, -0.021872999, -0.020457957, -0.017928645, -0.017646525, -0.015406465, -0.013729816, -0.013744593, -0.011489524, -0.013184322, -0.010947724, -0.009835883, -0.010391185, -0.0095338123, -0.012893084, -0.013729319, -0.015131517, -0.014853078, -0.014025724, -0.01544144, -0.016270865, -0.016255865, -0.015417486, -0.013161102, -0.008968683, -0.008123205, -0.0061689522, -0.0098229181, -0.0095495265, -0.013206156, -0.014320152, -0.014584199, -0.016211685, -0.014450426, -0.014702433, -0.012457201, -0.01053601, -0.0091677345, -0.0069794143, -0.0089382622, -0.010885914, -0.011442074, -0.012350644, -0.012917571, -0.013470566, -0.012354653, -0.013468444, -0.015166791, -0.01516854, -0.016285488, -0.019094463, -0.02135591, -0.021917498, -0.021624323, -0.022198029, -0.020517908, -0.020511057, -0.016273072, -0.015161882, -0.011497418, -0.010383787, -0.011222471, -0.013196116, -0.01544158, -0.017132564, -0.016837325, -0.016285125, -0.017692253, -0.018823558, -0.020219468, -0.020218065, -0.019363679, -0.015441396, -0.012900542, -0.0067295018, -0.0039301328, -0.0016843418, -0.0014053716, -0.001124999, -0.002249998, -0.00056513119, -0.0030946247, -0.00253125, -0.0033797496, -0.0061875004, -0.0089982469, -0.013196994, -0.014602197, -0.018253196, -0.019361068, -0.017408546, -0.016842905, -0.015438586, -0.013464953, -0.012900701, -0.0092628188, -0.0089782355, -0.0050620632, -0.0019817729, -0.00057136966, 0.0011075635, -5.739741e-06, -9.4098505e-06, -0.0025280898, -0.0036523875, -0.005619389, -0.0061776927, -0.0081445174, -0.0092659909, -0.0087084118, -0.0089814086, -0.0095444359, -0.009553371, -0.0092617851, -0.0070156581, -0.005046729, -0.0022464828, -1.0462012e-05, -0.00056947209, -6.2887557e-06, -0.0014146068, -0.0030879506, -0.0019715172, -0.0030896883, -0.0033681474, -0.0028072274, -0.0019661058, -0.0042033372, -0.0036481828, -0.0053309673, -0.0061755748, -0.0081499377, -0.0075832242, -0.0050537381, -0.0058966121, -0.0033679905, -0.0042108577, -0.0036467933, -0.0025209193, -0.0042070085, -0.0061724205, -0.0098193884, -0.012900542, -0.017104605, -0.019358397, -0.02022122, -0.022744223, -0.0227702, -0.021635354, -0.021905081, -0.019090302, -0.017688431, -0.014324283, -0.010956483, -0.0073032016, -0.0059009865, -0.0050530331, -0.0042117364, -0.0050477893, -0.0019645295, -0.0005689105, 0.0010982981, 0.0024931282, 0.0013983208, 0.00056780351, -0.00025605963, -0.0046870941, -0.0066257119, -0.0096989591, -0.011640996, -0.011366291, -0.010940522, -0.011221945, -0.010951553, -0.010667182, -0.010671018, -0.010669254, -0.011233866, -0.010956295, -0.011238974, -0.012073401, -0.011796014, -0.014318136, -0.012914719, -0.013194723, -0.010660518, -0.010095559, -0.010093458, -0.0084054545, -0.0092439698, -0.010935467, -0.012911042, -0.014592749, -0.017692972, -0.019356297, -0.019652065, -0.019932263, -0.019641951, -0.019361749, -0.017684445, -0.014301209, -0.011776787, -0.0075709769, -0.004484063, -0.0030851623, -0.0033641411, -0.0050481297, -0.0081219608, -0.010647064, -0.012903497, -0.013471588, -0.013195094, -0.012930477, -0.013205606, -0.01152424, -0.010957701, -0.0087069906, -0.0067440337, -0.0039348714, -0.0025259892, -0.0039247088, -0.0036397949, -0.0047663553, -0.0064440588, -0.0081292763, -0.0086987857, -0.0072996952, -0.0092759961, -0.006747012, -0.0058988766, -0.0039273174, -0.0019687498, -0.00055828132, 0.0025293173, 0.0033718417, 0.0056116795, 0.0056088776, 0.0050509269, 0.0030863846, -0.0019613947, -0.0047733542, -0.0081436252, -0.0078543294, -0.0070189987, -0.0053369119, -0.0039353985, -0.0025301992, 0.00028107309, 0.0028065345, 0.005331473, 0.0061692717, 0.0050551132, 0.0036469547, 0.00028560776, 1.7457642e-06, -0.0019594764, 0.00084269664, 0.0016827581, 0.0025280896, 0.0028142552, 0.0019680467, 0.0028124999, -0.0011257026, -0.0033728918, -0.0056172889, -0.0078599248, -0.0081378389, -0.0089826463, -0.010948231, -0.014044123, -0.01572266, -0.017122446, -0.017124545, -0.017404582, -0.017684035, -0.016292535, -0.017406274, -0.013753029, -0.014878539, -0.013734862, -0.012612482, -0.012059076, -0.010110788, -0.0078581674, -0.0058941497, -0.0044863401, -0.0014036214, 0.00028019925, 0.00084269664, 0.0008425212, -0.00084147282, -0.0025249454, -0.005050939, -0.0058910106, -0.007573246, -0.0078578293, -0.0098342756, -0.012925602, -0.01403305, -0.014892232, -0.013756694, -0.0098342933, -0.006458574, -0.00253125, -0.00028037117, 0.00028124999, -0.0008453331, -0.0016913624, -0.0028089865, -0.0033769321, -0.0050632027, -0.0053437497, -0.0042187497, -0.0042152395, -0.0058952146, -0.0075790482, -0.011214105, -0.01430016, -0.018232202, -0.019633595, -0.019345315, -0.019625036, -0.01795724, -0.01797373, -0.016857475, -0.018542536, -0.016856624, -0.015724257, -0.012635209, -0.010680149, -0.0087022912, -0.0056120418, -0.0044886065, -0.0044868574, -0.0056048678, -0.0067328485, -0.010093132, -0.013184257, -0.014576346, -0.013194382, -0.010391344, -0.0095540937, -0.0070280978, -0.0053383135, -0.0042134831, -0.0033728918, -0.0016864459, -3.8624275e-06, 0.00028124987, 0.0019648876, 0.00084322295, 0.0011230675, 0.0011292133, -0.0044891154, 0.028950656]

trigger_cell_from_stream = 313
channel_from_stream = 7

current_folder = os.path.dirname(os.path.abspath(__file__))

calibration = VoltageCalibration(os.path.join(current_folder, "wd136-5120.vcal"))

recalibrated_data = np.array(raw_value_from_stream)
recalibrated_data = (recalibrated_data.astype(np.float32) - 2048) / 4096
recalibrated_data = calibration.calibrate(recalibrated_data, trigger_cell_from_stream, channel_from_stream)

import matplotlib.pyplot as plt
plt.plot(recalibrated_data)
plt.plot(calibrated_value_from_stream)
plt.show()
